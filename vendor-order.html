<div style="background: white; padding: 20px 5%; display: flex; align-items: center; gap: 20px; border-bottom: 5px solid #2e7d32; border-radius: 20px 20px 0 0; max-width: 650px; margin: 30px auto -30px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); position: relative; z-index: 2;">
    <div style="height: 75px; width: 75px; border-radius: 50%; border: 3px solid #2e7d32; overflow: hidden; background: white;">
        <img src="https://raw.githubusercontent.com/juction4love/bimalpharmacy/main/logo.svg" alt="Bimal Pharmacy Logo" style="width: 100%; height: 100%; object-fit: cover;">
    </div>
    <div style="flex: 1;">
        <h1 style="color: #2e7d32; font-size: 1.8rem; margin: 0; line-height: 1.1;">рдмрд┐рдорд▓ рдлрд╛рд░реНрдореЗрд╕реА</h1>
        <p style="font-size: 0.85rem; color: #555; margin: 5px 0 0; font-weight: 600;">рднрд░рддрдкреБрд░-рен, рдЪрд┐рддрд╡рди (рдХреНрдпрд╛рдиреНрд╕рд░ рдЕрд╕реНрдкрддрд╛рд▓ рд░реЛрдб)</p>
    </div>
</div>

<div id="orderApp" style="border-top: 8px solid #2e7d32; background: #ffffff; padding: 45px 30px 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); max-width: 650px; margin: 0 auto 30px; font-family: 'Segoe UI', system-ui, sans-serif; transition: 0.3s; position: relative;">
    
    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 25px;">
        <div style="text-align: left;">
            <h2 style="color: #1b5e20; margin: 0; font-size: 1.5rem;"><i class="fas fa-file-invoice-dollar"></i> Smart Order Slip</h2>
            <p style="font-size: 0.8rem; color: #666;">рдЖрдзрд┐рдХрд╛рд░рд┐рдХ рдбрд┐рдЬрд┐рдЯрд▓ рдЦрд░рд┐рдж рдЕрд░реНрдбрд░</p>
        </div>
        <button onclick="toggleDarkMode()" style="background: #f0f0f0; border: none; padding: 10px; border-radius: 50%; cursor: pointer;"><i class="fas fa-moon"></i></button>
    </div>
    
    <div style="display: flex; justify-content: space-between; background: #f1f8f1; padding: 12px; border-radius: 12px; margin-bottom: 20px; font-size: 0.85rem; border: 1px solid #ddd;">
      <span><i class="far fa-calendar-check"></i> рдорд┐рддрд┐: <span id="currentDate" style="font-weight: bold;"></span></span>
      <span style="color: #d32f2f; font-weight: bold;">ID: <span id="orderID"></span></span>
    </div>

    <div style="margin-bottom: 15px;">
        <label style="font-weight: 700; display: block; margin-bottom: 5px;">рд╡рд┐рдХреНрд░реЗрддрд╛ / рд╕рдкреНрд▓рд╛рдпрд░рдХреЛ рдирд╛рдо:</label>
        <div style="position: relative;">
            <i class="fas fa-truck-moving" style="position: absolute; left: 15px; top: 15px; color: #888;"></i>
            <input type="text" id="vendorName" placeholder="рд╕рдкреНрд▓рд╛рдпрд░ рд╡рд╛ рдХрдореНрдкрдиреАрдХреЛ рдирд╛рдо" style="width: 100%; padding: 12px 12px 12px 45px; border-radius: 12px; border: 1px solid #ccc; outline: none; background: #fafafa; font-size: 1rem;">
        </div>
    </div>

    <div style="margin-bottom: 20px; position: relative;">
        <label style="font-weight: 700; display: block; margin-bottom: 5px;">рд╕рд╛рдорд╛рдирдХреЛ рд╡рд┐рд╡рд░рдг (Items List):</label>
        <textarea id="itemList" rows="8" placeholder="рдЙрджрд╛: &#10;1. Paracetamol 500mg - 10 Boxes" style="width: 100%; padding: 15px; border-radius: 12px; border: 1px solid #ccc; outline: none; background: #fafafa; resize: vertical; font-size: 1rem; font-family: inherit;"></textarea>
        <button onclick="startDictation()" title="рдмреЛрд▓реЗрд░ рд▓реЗрдЦреНрдиреБрд╣реЛрд╕реН" style="position: absolute; right: 12px; bottom: 12px; background: #d32f2f; color: white; border: none; width: 42px; height: 42px; border-radius: 50%; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2);">
            <i class="fas fa-microphone"></i>
        </button>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
        <button onclick="sendToMe()" style="background: #075E54; color: white; padding: 16px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
            <i class="fab fa-whatsapp"></i> My WhatsApp
        </button>
        <button onclick="chooseSupplier()" style="background: #2e7d32; color: white; padding: 16px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
            <i class="fas fa-share-alt"></i> Any Supplier
        </button>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px;">
        <button onclick="printOrder()" style="background: #455a64; color: white; padding: 12px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer;">
            <i class="fas fa-print"></i> Print
        </button>
        <button onclick="generatePDF()" style="background: #0288d1; color: white; padding: 12px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer;">
            <i class="fas fa-file-pdf"></i> PDF
        </button>
        <button onclick="nativeShare()" style="background: #607d8b; color: white; padding: 12px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer;">
            <i class="fas fa-share"></i> Share
        </button>
    </div>

    <button onclick="clearForm()" style="background: #f5f5f5; color: #d32f2f; width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 12px; font-weight: bold; cursor: pointer;">
        <i class="fas fa-eraser"></i> Clear Form (рдЦрд╛рд▓реА рдЧрд░реНрдиреБрд╣реЛрд╕реН)
    </button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
    // 1. Auto Generation
    function setupOrder() {
        const now = new Date();
        document.getElementById('currentDate').innerText = now.toLocaleDateString('ne-NP', { year: 'numeric', month: 'long', day: 'numeric' });
        const dateID = now.getFullYear() + String(now.getMonth() + 1).padStart(2, '0') + String(now.getDate()).padStart(2, '0');
        document.getElementById('orderID').innerText = `BIMAL-${dateID}-${Math.floor(1000 + Math.random() * 9000)}`;
    }
    setupOrder();

    // 2. Message Logic
    function createMessage() {
        const vName = document.getElementById('vendorName').value.trim() || "рдЬреА";
        const items = document.getElementById('itemList').value.trim();
        const id = document.getElementById('orderID').innerText;
        const date = document.getElementById('currentDate').innerText;

        if (!items) { alert("рдХреГрдкрдпрд╛ рд╕рд╛рдорд╛рдирдХреЛ рд╡рд┐рд╡рд░рдг рднрд░реНрдиреБрд╣реЛрд╕реНред"); return null; }

        return "рдирдорд╕реНрддреЗ " + vName + ", ЁЯЩП%0A" +
               "рдо рдмрд┐рдорд▓ рдлрд╛рд░реНрдореЗрд╕реА (рднрд░рддрдкреБрд░) рдмрд╛рдЯ рдмрд┐рдорд▓ рд▓рд╛рдорд┐рдЫрд╛рдиреЗред рд╣рд╛рдореНрд░реЛ рдлрд╛рд░реНрдореЗрд╕реАрдХреЛ рд▓рд╛рдЧрд┐ рдЖрд╡рд╢реНрдпрдХ рдХреЗрд╣реА рд╕рд╛рдорд╛рдирд╣рд░реВрдХреЛ *рдирдпрд╛рдБ рдЦрд░рд┐рдж рдЕрд░реНрдбрд░ (Purchase Order)* рдкрдард╛рдПрдХреЛ рдЫреБред рдХреГрдкрдпрд╛ рдЙрд▓реНрд▓реЗрдЦрд┐рдд рд╕рд╛рдорд╛рдирд╣рд░реВ рдЙрдкрд▓рдмреНрдз рдЧрд░рд╛рдИ рд╕рд╣рдпреЛрдЧ рдЧрд░рд┐рджрд┐рдиреБрд╣реБрди рд╣рд╛рд░реНрджрд┐рдХ рдЕрдиреБрд░реЛрдз рдЧрд░реНрджрдЫреБ:%0A%0A" +
               "тФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБ%0A" +
               "ЁЯУМ *ORDER LIST:*%0A" + 
               "тФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБ%0A" +
               encodeURIComponent(items) + "%0A" +
               "тФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБ%0A%0A" +
               "ЁЯУЕ рдорд┐рддрд┐: " + date + "%0A" +
               "ЁЯФв рдЕрд░реНрдбрд░ ID: #" + id + "%0A%0A" +
               "рд╕рд╛рдорд╛рди рдХрдиреНрдлрд░реНрдо рднрдПрдкрдЫрд┐ рдорд▓рд╛рдИ рдЬрд╛рдирдХрд╛рд░реА рджрд┐рдиреБрд╣реЛрд▓рд╛ред%0A" +
               "рдзрдиреНрдпрд╡рд╛рджред - рдмрд┐рдорд▓ рд▓рд╛рдорд┐рдЫрд╛рдиреЗ%0A" +
               "ЁЯУЮ репреорелрелрежремрелрейреирен";
    }

    // 3. IMPROVED PRINT FUNCTION (Connected to Default Printer Style)
    function printOrder() {
        const vendor = document.getElementById('vendorName').value || "N/A";
        const items = document.getElementById('itemList').value;
        const id = document.getElementById('orderID').innerText;
        const date = document.getElementById('currentDate').innerText;

        if (!items) return alert("Items list is empty!");

        const win = window.open('', '', 'height=700,width=900');
        win.document.write(`
            <html>
            <head>
                <title>Order #${id}</title>
                <style>
                    @page { size: auto; margin: 10mm; }
                    body { font-family: 'Segoe UI', Arial, sans-serif; padding: 20px; color: #333; }
                    .bill-container { border: 2px solid #2e7d32; padding: 30px; border-radius: 15px; }
                    .hd { text-align: center; border-bottom: 3px solid #2e7d32; padding-bottom: 10px; margin-bottom: 20px; }
                    .hd h1 { margin: 0; color: #2e7d32; font-size: 28px; }
                    .meta { display: flex; justify-content: space-between; font-size: 15px; margin-bottom: 25px; }
                    .items-box { background: #fdfdfd; padding: 20px; border: 1px dashed #2e7d32; min-height: 250px; white-space: pre-wrap; font-size: 17px; line-height: 1.8; }
                    .footer { text-align: center; margin-top: 40px; font-size: 13px; color: #555; border-top: 1px solid #ddd; padding-top: 15px; }
                </style>
            </head>
            <body>
                <div class="bill-container">
                    <div class="hd">
                        <h1>рдмрд┐рдорд▓ рдлрд╛рд░реНрдореЗрд╕реА</h1>
                        <p>рднрд░рддрдкреБрд░-рен, рдЪрд┐рддрд╡рди | рдлреЛрди: репреорелрелрежремрелрейреирен</p>
                        <h2 style="background:#2e7d32; color:white; display:inline-block; padding:5px 20px; border-radius:8px;">PURCHASE ORDER</h2>
                    </div>
                    <div class="meta">
                        <div><strong>To (рд╡рд┐рдХреНрд░реЗрддрд╛):</strong> ${vendor}</div>
                        <div style="text-align: right;"><strong>рдорд┐рддрд┐:</strong> ${date}<br><strong>Order ID:</strong> #${id}</div>
                    </div>
                    <div style="font-weight: bold; margin-bottom: 10px; font-size: 18px;">Items Details:</div>
                    <div class="items-box">${items}</div>
                    <div class="footer">
                        <p>рдпреЛ рдмрд┐рдорд▓ рдлрд╛рд░реНрдореЗрд╕реАрдХреЛ рдЖрдзрд┐рдХрд╛рд░рд┐рдХ рдбрд┐рдЬрд┐рдЯрд▓ рдЕрд░реНрдбрд░ рдХрдкреА рд╣реЛред</p>
                        <strong>рдмрд┐рдорд▓ рд▓рд╛рдорд┐рдЫрд╛рдиреЗ (Proprietor)</strong>
                    </div>
                </div>
            </body>
            </html>
        `);
        win.document.close();
        win.focus();
        setTimeout(() => { win.print(); win.close(); }, 600);
    }

    // 4. Other Functions
    function startDictation() {
        if (window.hasOwnProperty('webkitSpeechRecognition')) {
            var recognition = new webkitSpeechRecognition();
            recognition.lang = "ne-NP";
            recognition.onresult = (e) => { document.getElementById('itemList').value += e.results[0][0].transcript + "\n"; recognition.stop(); };
            recognition.start();
        } else { alert("Speech not supported"); }
    }

    function generatePDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text("BIMAL PHARMACY - PURCHASE ORDER", 10, 15);
        doc.text("ID: " + document.getElementById('orderID').innerText, 10, 25);
        doc.text("Vendor: " + document.getElementById('vendorName').value, 10, 35);
        doc.text("Items List:\n" + document.getElementById('itemList').value, 10, 50);
        doc.save(`Bimal_Order_${document.getElementById('orderID').innerText}.pdf`);
    }

    function toggleDarkMode() {
        const app = document.getElementById('orderApp');
        const isDark = app.style.background === 'rgb(34, 34, 34)';
        app.style.background = isDark ? '#ffffff' : '#222222';
        app.style.color = isDark ? '#333' : '#fff';
    }

    function sendToMe() { const msg = createMessage(); if(msg) window.open("https://wa.me/9779855065327?text=" + msg, '_blank'); }
    function chooseSupplier() { const msg = createMessage(); if(msg) window.open("https://wa.me/?text=" + msg, '_blank'); }
    async function nativeShare() { const msg = createMessage(); if(msg) navigator.share({title:'Order Slip', text:decodeURIComponent(msg)}); }
    function clearForm() { if(confirm("рдирдпрд╛рдБ рдЕрд░реНрдбрд░рдХрд╛ рд▓рд╛рдЧрд┐ рдлрд░реНрдо рдЦрд╛рд▓реА рдЧрд░реНрдиреЗ?")) { document.getElementById('vendorName').value=""; document.getElementById('itemList').value=""; setupOrder(); } }
</script>
