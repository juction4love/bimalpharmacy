<div id="orderApp" class="card" style="border-top: 8px solid #2e7d32; background: #ffffff; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); max-width: 650px; margin: 30px auto; font-family: 'Segoe UI', system-ui, sans-serif; transition: 0.3s; position: relative; overflow: hidden;">
    
    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 25px;">
        <div style="text-align: left;">
            <h2 style="color: #1b5e20; margin: 0; font-size: 1.8rem;"><i class="fas fa-file-invoice-dollar"></i> Smart Order Slip</h2>
            <p style="font-size: 0.85rem; color: #666;">рдмрд┐рдорд▓ рдлрд╛рд░реНрдореЗрд╕реА - рдЧреБрдгрд╕реНрддрд░реАрдп рдЦрд░рд┐рдж рд╡реНрдпрд╡рд╕реНрдерд╛рдкрди</p>
        </div>
        <button onclick="toggleDarkMode()" id="themeBtn" style="background: #eee; border: none; padding: 10px; border-radius: 50%; cursor: pointer; transition: 0.3s;"><i class="fas fa-moon"></i></button>
    </div>
    
    <div style="display: flex; justify-content: space-between; background: #f1f8f1; padding: 12px; border-radius: 12px; margin-bottom: 20px; font-size: 0.85rem; border: 1px solid #ddd;">
      <span><i class="far fa-calendar-check"></i> рдорд┐рддрд┐: <span id="currentDate" style="font-weight: bold;"></span></span>
      <span style="color: #d32f2f; font-weight: bold;">ORDER ID: <span id="orderID"></span></span>
    </div>

    <div style="margin-bottom: 15px;">
        <label style="font-weight: 700; display: block; margin-bottom: 5px;">рд╡рд┐рдХреНрд░реЗрддрд╛ / рд╕рдкреНрд▓рд╛рдпрд░рдХреЛ рдирд╛рдо:</label>
        <div style="position: relative;">
            <i class="fas fa-user-tie" style="position: absolute; left: 15px; top: 15px; color: #888;"></i>
            <input type="text" id="vendorName" placeholder="рд╕рдкреНрд▓рд╛рдпрд░ рд╡рд╛ рдХрдореНрдкрдиреАрдХреЛ рдирд╛рдо" style="width: 100%; padding: 12px 12px 12px 45px; border-radius: 12px; border: 1px solid #ccc; outline: none; background: #fafafa; font-size: 1rem;">
        </div>
    </div>

    <div style="margin-bottom: 20px; position: relative;">
        <label style="font-weight: 700; display: block; margin-bottom: 5px;">рд╕рд╛рдорд╛рдирдХреЛ рд╡рд┐рд╡рд░рдг (Items List):</label>
        <textarea id="itemList" rows="8" placeholder="рдЙрджрд╛: &#10;1. Paracetamol 500mg - 10 Boxes" style="width: 100%; padding: 15px; border-radius: 12px; border: 1px solid #ccc; outline: none; background: #fafafa; resize: vertical; font-size: 1rem; font-family: inherit;"></textarea>
        <button onclick="startDictation()" title="рдмреЛрд▓реЗрд░ рд▓реЗрдЦреНрдиреБрд╣реЛрд╕реН" style="position: absolute; right: 12px; bottom: 12px; background: #d32f2f; color: white; border: none; width: 42px; height: 42px; border-radius: 50%; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: 0.3s;">
            <i class="fas fa-microphone"></i>
        </button>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
        <button onclick="sendToMe()" style="background: #075E54; color: white; padding: 16px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 1rem; transition: 0.3s;">
            <i class="fab fa-whatsapp"></i> My WhatsApp
        </button>
        <button onclick="chooseSupplier()" style="background: #2e7d32; color: white; padding: 16px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 1rem; transition: 0.3s;">
            <i class="fas fa-share-alt"></i> Any Supplier
        </button>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px;">
        <button onclick="printOrder()" style="background: #455a64; color: white; padding: 12px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 0.85rem;">
            <i class="fas fa-print"></i> Print
        </button>
        <button onclick="generatePDF()" style="background: #0288d1; color: white; padding: 12px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 0.85rem;">
            <i class="fas fa-file-pdf"></i> PDF
        </button>
        <button onclick="nativeShare()" style="background: #607d8b; color: white; padding: 12px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 0.85rem;">
            <i class="fas fa-share"></i> Share
        </button>
    </div>

    <button onclick="clearForm()" style="background: #f5f5f5; color: #d32f2f; width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 12px; font-weight: bold; cursor: pointer; transition: 0.2s;">
        <i class="fas fa-eraser"></i> Clear Form (рдЦрд╛рд▓реА рдЧрд░реНрдиреБрд╣реЛрд╕реН)
    </button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
    // рез. Auto ID рд░ рдорд┐рддрд┐ рд╕реЗрдЯрд┐рдЩ
    function generateAutoID() {
        const now = new Date();
        const options = { year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('currentDate').innerText = now.toLocaleDateString('ne-NP', options);
        
        // Auto ID Format: BIMAL-YYYYMMDD-Random
        const dateStr = now.getFullYear() + String(now.getMonth() + 1).padStart(2, '0') + String(now.getDate()).padStart(2, '0');
        const randomNum = Math.floor(1000 + Math.random() * 9000);
        document.getElementById('orderID').innerText = `BIMAL-${dateStr}-${randomNum}`;
    }
    generateAutoID();

    // реи. рд╕рдиреНрджреЗрд╢ рддрдпрд╛рд░ рдкрд╛рд░реНрдиреЗ (рддрдкрд╛рдИрдБрд▓реЗ рдЫрд╛рдиреНрдиреБрднрдПрдХреЛ рд╡реНрдпрд╛рд╡рд╕рд╛рдпрд┐рдХ рднрд╛рд╖рд╛)
    function createMessage() {
        const vName = document.getElementById('vendorName').value.trim() || "рд╕рд░";
        const items = document.getElementById('itemList').value.trim();
        const id = document.getElementById('orderID').innerText;
        const date = document.getElementById('currentDate').innerText;

        if (!items) { alert("рдХреГрдкрдпрд╛ рд╕рд╛рдорд╛рдирдХреЛ рд╡рд┐рд╡рд░рдг рднрд░реНрдиреБрд╣реЛрд╕реНред"); return null; }

        return "рдирдорд╕реНрддреЗ " + vName + ", ЁЯЩП%0A" +
               "рдо рдмрд┐рдорд▓ рдлрд╛рд░реНрдореЗрд╕реА (рднрд░рддрдкреБрд░) рдмрд╛рдЯ рдмрд┐рдорд▓ рд▓рд╛рдорд┐рдЫрд╛рдиреЗред рд╣рд╛рдореНрд░реЛ рдлрд╛рд░реНрдореЗрд╕реАрдХреЛ рд▓рд╛рдЧрд┐ рдЖрд╡рд╢реНрдпрдХ рдХреЗрд╣реА рд╕рд╛рдорд╛рдирд╣рд░реВрдХреЛ *рдирдпрд╛рдБ рдЦрд░рд┐рдж рдЕрд░реНрдбрд░ (Purchase Order)* рдпрд╕реИ рд╕рдиреНрджреЗрд╢рдорд╛рд░реНрдлрдд рдкрдард╛рдПрдХреЛ рдЫреБред рдХреГрдкрдпрд╛ рдЙрд▓реНрд▓реЗрдЦрд┐рдд рд╕рд╛рдорд╛рдирд╣рд░реВ рдЙрдкрд▓рдмреНрдз рдЧрд░рд╛рдИ рд╕рд╣рдпреЛрдЧ рдЧрд░рд┐рджрд┐рдиреБрд╣реБрди рд╣рд╛рд░реНрджрд┐рдХ рдЕрдиреБрд░реЛрдз рдЧрд░реНрджрдЫреБ:%0A%0A" +
               "тФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБ%0A" +
               "ЁЯУМ *ORDER LIST:*%0A" + 
               "тФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБ%0A" +
               encodeURIComponent(items) + "%0A" +
               "тФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБ%0A%0A" +
               "ЁЯУЕ рдорд┐рддрд┐: " + date + "%0A" +
               "ЁЯФв рдЕрд░реНрдбрд░ ID: #" + id + "%0A%0A" +
               "рдзрдиреНрдпрд╡рд╛рджред - %0A" +
               "ЁЯУЮ ";
    }

    // рей. Voice Typing
    function startDictation() {
        if (window.hasOwnProperty('webkitSpeechRecognition')) {
            var recognition = new webkitSpeechRecognition();
            recognition.lang = "ne-NP";
            recognition.start();
            recognition.onresult = function(e) {
                document.getElementById('itemList').value += e.results[0][0].transcript + "\n";
                recognition.stop();
            };
        } else { alert("рднреНрд╡рд╛рдЗрд╕ рдЯрд╛рдЗрдкрд┐рдЩ рд╕рдкреЛрд░реНрдЯ рдЧрд░реЗрдиред"); }
    }

    // рек. Print Function
    function printOrder() {
        const vendor = document.getElementById('vendorName').value || "рд╕рдкреНрд▓рд╛рдпрд░";
        const items = document.getElementById('itemList').value;
        const id = document.getElementById('orderID').innerText;
        const date = document.getElementById('currentDate').innerText;

        if (!items) return alert("Items empty!");

        const printWin = window.open('', '', 'height=600,width=800');
        printWin.document.write('<html><head><title>Bimal Pharmacy Order</title>');
        printWin.document.write('<style>body{font-family:sans-serif;padding:30px;} .header{text-align:center;border-bottom:3px solid #2e7d32;} .items{background:#f4f4f4;padding:20px;border-radius:10px;white-space:pre-wrap;}</style></head><body>');
        printWin.document.write('<div class="header"><h1>рдмрд┐рдорд▓ рдлрд╛рд░реНрдореЗрд╕реА</h1><p>рднрд░рддрдкреБрд░-рен, рдЪрд┐рддрд╡рди | рдлреЛрди: репреорелрелрежремрелрейреирен</p></div>');
        printWin.document.write('<h3>Purchase Order (ID: #' + id + ')</h3>');
        printWin.document.write('<p><strong>рд╡рд┐рдХреНрд░реЗрддрд╛:</strong> ' + vendor + '<br><strong>рдорд┐рддрд┐:</strong> ' + date + '</p>');
        printWin.document.write('<h4>рд╕рд╛рдорд╛рдирдХреЛ рд╕реВрдЪреА:</h4><div class="items">' + items + '</div>');
        printWin.document.write('<p style="text-align:center;margin-top:50px;">┬й реирежреирем рдмрд┐рдорд▓ рдлрд╛рд░реНрдореЗрд╕реА</p></body></html>');
        printWin.document.close();
        printWin.print();
    }

    // рел. PDF & Share
    function generatePDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text("Bimal Pharmacy - Purchase Order", 10, 10);
        doc.text("Order ID: " + document.getElementById('orderID').innerText, 10, 20);
        doc.text("Items:\n" + document.getElementById('itemList').value, 10, 40);
        doc.save(`Order_${document.getElementById('orderID').innerText}.pdf`);
    }

    async function nativeShare() {
        const msg = createMessage();
        if(msg) {
            try { await navigator.share({ title: 'Bimal Order', text: decodeURIComponent(msg) }); } 
            catch (err) { alert("Share not supported"); }
        }
    }

    // рем. Utility
    function toggleDarkMode() {
        const app = document.getElementById('orderApp');
        const isDark = app.style.background === 'rgb(34, 34, 34)';
        app.style.background = isDark ? '#ffffff' : '#222222';
        app.style.color = isDark ? '#2c3e50' : '#ffffff';
    }

    function sendToMe() { const msg = createMessage(); if(msg) window.open("https://wa.me/9779855065327?text=" + msg, '_blank'); }
    function chooseSupplier() { const msg = createMessage(); if(msg) window.open("https://wa.me/?text=" + msg, '_blank'); }
    
    function clearForm() { 
        if(confirm("рдирдпрд╛рдБ рдЕрд░реНрдбрд░рдХрд╛ рд▓рд╛рдЧрд┐ рдлрд░реНрдо рдЦрд╛рд▓реА рдЧрд░реНрдиреЗ?")) { 
            document.getElementById('vendorName').value=""; 
            document.getElementById('itemList').value=""; 
            generateAutoID(); 
        } 
    }
</script>
