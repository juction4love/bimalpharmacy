<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bimal Pharmacy Search</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.6.2/fuse.min.js"></script>
    
    <style>
        /* General Body Styling */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: #f4f7f6; 
            margin: 0; 
            padding: 15px; 
        }

        /* Container Styling */
        .container { 
            max-width: 600px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
        }

        h2 { 
            text-align: center; 
            color: #2c3e50; 
            margin-bottom: 20px; 
        }
        
        /* Search Box Styling */
        .search-box {
            width: 100%; 
            padding: 15px; 
            font-size: 18px; 
            border: 2px solid #ddd; 
            border-radius: 8px; 
            box-sizing: border-box; 
            outline: none;
            transition: border-color 0.3s;
        }
        .search-box:focus { 
            border-color: #3498db; 
        }
        
        /* Loading Text */
        #loading { 
            text-align: center; 
            margin-top: 20px; 
            color: #666; 
            font-style: italic; 
        }
        
        /* Results List */
        #results { 
            margin-top: 15px; 
            max-height: 65vh; 
            overflow-y: auto; 
        }

        /* Individual Medicine Card */
        .card { 
            background: #fff; 
            border-bottom: 1px solid #f0f0f0; 
            padding: 15px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .card:hover {
            background-color: #fafafa;
        }
        .name { 
            font-weight: 600; 
            color: #333; 
            font-size: 16px; 
        }
        .price { 
            color: #27ae60; 
            font-weight: bold; 
            font-size: 18px; 
        }
        
        /* Error/No Result Messages */
        .no-result { 
            text-align: center; 
            padding: 20px; 
            color: #e74c3c; 
        }
        .error-msg {
            color: red;
            text-align: center;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>ðŸ’Š Bimal Pharmacy Price List</h2>
    
    <input type="text" id="searchBox" class="search-box" placeholder="Loading data..." disabled>
    
    <div id="loading">Connecting to GitHub database... please wait.</div>
    <div id="results"></div>
</div>

<script>
    // URL to your GitHub Excel file
    const excelUrl = "https://github.com/juction4love/bimalpharmacy/raw/refs/heads/main/medicines.xlsx";

    let fuse; // Variable to hold the search engine instance

    // Function 1: Fetch and Load Data from GitHub
    async function loadData() {
        const loading = document.getElementById('loading');
        const searchBox = document.getElementById('searchBox');

        try {
            // Fetch the file
            const response = await fetch(excelUrl);
            
            if (!response.ok) throw new Error("Failed to fetch file from GitHub.");

            // Process the file data
            const arrayBuffer = await response.arrayBuffer();
            const data = new Uint8Array(arrayBuffer);
            const workbook = XLSX.read(data, { type: 'array' });

            // Read the first sheet
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(firstSheet);

            // Map the data (Matches your Excel columns: Prodname & S_price)
            const medicines = jsonData.map(item => ({
                name: item.Prodname ? String(item.Prodname) : "",
                price: item.S_price || "N/A"
            })).filter(item => item.name !== ""); // Remove empty rows

            // Initialize Fuzzy Search
            fuse = new Fuse(medicines, {
                keys: ['name'],
                threshold: 0.3, // Allows slight spelling mistakes
                ignoreLocation: true
            });

            // UI Update: Enable search box
            loading.style.display = 'none';
            searchBox.disabled = false;
            searchBox.placeholder = "Type medicine name here...";
            searchBox.focus();

        } catch (error) {
            console.error(error);
            loading.innerHTML = `<div class='error-msg'>Error: ${error.message}<br>Please check your internet connection.</div>`;
        }
    }

    // Function 2: Handle Search Input
    document.getElementById('searchBox').addEventListener('input', (e) => {
        const query = e.target.value.trim();
        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = '';

        // Do not search if less than 2 characters
        if (query.length < 2) return;

        // Perform the search
        const results = fuse.search(query);

        if (results.length > 0) {
            // Limit to top 50 results for performance
            results.slice(0, 50).forEach(result => {
                const item = result.item;
                // Format price to 2 decimal places if it's a number
                const price = typeof item.price === 'number' ? item.price.toFixed(2) : item.price;
                
                resultsDiv.innerHTML += `
                    <div class="card">
                        <div class="name">${item.name}</div>
                        <div class="price">Rs. ${price}</div>
                    </div>`;
            });
        } else {
            resultsDiv.innerHTML = `<div class="no-result">No medicine found with that name.</div>`;
        }
    });

    // Start loading data when the page opens
    window.onload = loadData;
</script>

</body>
</html>
